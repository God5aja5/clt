{% extends "base.html" %}

{% block content %}
<h1 class="text-3xl font-bold text-center mb-8">Your Shopping Cart</h1>

{% if products_in_cart %}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Cart Items -->
        <div class="lg:col-span-2 space-y-4">
            {% for item in products_in_cart %}
                <div class="bg-white rounded-lg shadow p-6 flex items-center">
                    {% if item.product.get_first_image() %}
                        <img src="{{ url_for('static', filename='uploads/' + item.product.get_first_image().filename) }}" 
                             alt="{{ item.product.title }}" class="w-24 h-24 object-cover rounded mr-4">
                    {% else %}
                        <div class="w-24 h-24 bg-gray-200 rounded mr-4 flex items-center justify-center">
                            <i class="fas fa-image text-gray-500"></i>
                        </div>
                    {% endif %}
                    
                    <div class="flex-grow">
                        <h3 class="text-lg font-bold">{{ item.product.title }}</h3>
                        <p class="text-gray-600">₹{{ "%.2f"|format(item.unit_price) }} each</p>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <form method="POST" action="{{ url_for('main.update_cart_quantity') }}" class="flex items-center space-x-2">
                            <input type="hidden" name="product_id" value="{{ item.product.id }}">
                            <button type="button" class="w-8 h-8 rounded-full border flex items-center justify-center" 
                                    onclick="decreaseQuantity({{ item.product.id }})">-</button>
                            <input type="number" name="quantity" value="{{ item.quantity }}" min="1" 
                                   class="w-12 text-center border rounded py-1" 
                                   onchange="updateQuantity({{ item.product.id }}, this.value)"
                                   id="qty-{{ item.product.id }}">
                            <button type="button" class="w-8 h-8 rounded-full border flex items-center justify-center" 
                                    onclick="increaseQuantity({{ item.product.id }})">+</button>
                        </form>
                        
                        <form method="POST" action="{{ url_for('main.remove_from_cart') }}" class="ml-4">
                            <input type="hidden" name="product_id" value="{{ item.product.id }}">
                            <button type="submit" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                    
                    <div class="ml-4 text-right">
                        <div class="font-bold">₹{{ "%.2f"|format(item.line_total) }}</div>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <!-- Cart Summary -->
        <div class="bg-white rounded-lg shadow p-6 h-fit sticky top-24">
            <h2 class="text-xl font-bold mb-4">Order Summary</h2>
            
            <div class="space-y-2 mb-4">
                <div class="flex justify-between">
                    <span>Subtotal:</span>
                    <span>₹{{ "%.2f"|format(subtotal) }}</span>
                </div>
                <div class="flex justify-between">
                    <span>Discount:</span>
                    <span class="text-green-600">-{{ settings.global_discount_percent }}%</span>
                </div>
                <div class="border-t pt-2">
                    <div class="flex justify-between font-bold text-lg">
                        <span>Total:</span>
                        <span>₹{{ "%.2f"|format(subtotal) }}</span>
                    </div>
                </div>
            </div>
            
            <a href="{{ url_for('main.checkout') }}" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold block text-center">
                Proceed to Checkout
            </a>
        </div>
    </div>
{% else %}
    <div class="text-center py-12">
        <i class="fas fa-shopping-cart text-5xl text-gray-400 mb-4"></i>
        <h3 class="text-2xl font-bold text-gray-600 mb-2">Your cart is empty</h3>
        <p class="text-gray-500 mb-6">Add some products to your cart to get started</p>
        <a href="{{ url_for('main.index') }}" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold">
            Continue Shopping
        </a>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    function increaseQuantity(productId) {
        const input = document.getElementById(`qty-${productId}`);
        let value = parseInt(input.value) || 0;
        input.value = value + 1;
        updateQuantity(productId, input.value);
    }
    
    function decreaseQuantity(productId) {
        const input = document.getElementById(`qty-${productId}`);
        let value = parseInt(input.value) || 1;
        if (value > 1) {
            input.value = value - 1;
            updateQuantity(productId, input.value);
        }
    }
    
    function updateQuantity(productId, quantity) {
        // Update quantity via AJAX to avoid page refresh
        fetch("{{ url_for('main.update_cart_quantity') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `product_id=${productId}&quantity=${quantity}`
        }).then(response => {
            if (response.ok) {
                location.reload(); // Simple approach: reload page after update
            }
        });
    }
</script>
{% endblock %}